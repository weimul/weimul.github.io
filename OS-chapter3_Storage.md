# 三， 存储

## 存储管理概述

- 存储管理的要求：重定位；保护；共享；逻辑组织；物理组织
- 现代存储系统的结构
  ![image-20230404130854774](C:\Users\23237\AppData\Roaming\Typora\typora-user-images\image-20230404130854774.png)

## 程序的装入和链接

用户源程序变成一个可在内存中执行的程序的三个步骤：

1. 编译：由编译程序（compiler）将用户源代码编译为若干目标模块
2. 链接：由链接程序（linker）将一组目标模块以及对应所需库函数链接，形成一个装入模块
3. 装入：由装入程序（loader）将装入模块装入内存

### 装入



### 链接

## 存储分配技术

- [ ] > 内部碎片和外部碎片

### 连续分配方式

- 指为一个用户程序分配一个连续的内存空间

- 连续分配方式共四种：单一连续分配；固定分区分配；动态分区分配；可重定位分区分配。

#### 单一连续分配

- 适用：单用户单任务系统

- 内存分为系统区和用户区：系统区仅提供OS使用，通常是放在内存的低址部分；用户区是指除了系统区的全部内存空间提供给用户使用

#### 固定分区分配

将内存用户空间划分为若干固定大小区域，每一个分区只装入一道作业

1. 划分分区的方法：分区大小相等和分区大小不等。
2. 实现的优化方法：将分区按大小排队。建立一张分区使用表
3. 优点：可运行多道程序的存储管理方式；缺点：存在"内零头"，空间
4. 内零头：分区内没有利用的部分。（内部碎片）

#### 动态分区方式

动态分配内存空间

##### 相应的数据结构

1. 空闲分区表：设置在系统中，记录每个空闲分区的情况
2. 空闲分区链：实现对空闲分区的分配和链接。设置前向指针和后向指针将空闲分区链接成一个双向链。

##### 分配方法

- 首次匹配（首次适应算法FF）：空间分区链以地址递增的次序链接。分配内存从链首开始顺序查找，直到找到大小满足要求的空闲分区。
  优缺点：为大作业分配大空间创造条件。低址部分不断被划分，会留下很多外部碎片。
- 循环匹配（循环首次适应算法）：将空闲分区构成一个循环链表，循环查找。
  优缺点：（因为起点是分散的）使得内存分布更均匀，减少查找空闲分区的开销。缺乏大的空闲分区。
- 最佳匹配（最佳适应算法）：将所有的分区按其容量从小到大的顺序形成空闲分布链。
  优缺点：为大作业分配大的内存空间创造了条件。每次分配切割下的剩余部分总是最小的，这样会留下很多小空闲区（外部碎片）。
- 最坏匹配（最坏适应算法）：从大到小。
  优缺点：避免了难以利用的小空闲区的出现。缺乏大的空闲空间。

##### 分区回收

当进程运行完毕释放内存时，需要合并相邻的空闲分区，形成大的分区，成为合并技术

#### 可重定位分区分配

采用动态重定位技术的分区分配

- 紧凑：将内存中的所有作业进行移动，使它们全部相邻接，把原来的多个分散小分区合成为一个大分区

  ![image-20230404142637387](C:\Users\23237\AppData\Roaming\Typora\typora-user-images\image-20230404142637387.png)

  > 紧凑是比较花时间的。

- 分配算法![image-20230404142725196](C:\Users\23237\AppData\Roaming\Typora\typora-user-images\image-20230404142725196.png)

#### 动态分区的示例-伙伴系统

伙伴系统是一种不需要紧凑的动态分区算法的内存块管理机制，采用二进制的方式来分配空间。

##### 实现方式

假设整个内存的大小为2^U^。在伙伴系统中，系统初始启动时整个内存将被视作单一的空闲分区。如果进程请求的尺寸s在2^U-1^ **< s <= 2^U^之间，则全部分给进程，否则一分为二，再继续比较，直到满足需要的最小者为止。![image-20230404143638245](C:\Users\23237\AppData\Roaming\Typora\typora-user-images\image-20230404143638245.png)

##### Linux内存管理

Linux采用多种内存分配策略，2.4版采用伙伴系统。

- 把内存划分为块组，大小为2的幂次，如1页=2^0^、2页=2^1^、4页=2^2^等。
- 将相同大小的组织成一个队列。并用位示图表示占用与否。
- 将多个队列组织成一个表。

![image-20230404144531017](C:\Users\23237\AppData\Roaming\Typora\typora-user-images\image-20230404144531017.png)

### 离散分配方式

为进程分配的空间不要求是连续的，可以是多个分离的空间。

离散分配方式的存储管理主要有三种：分页、段式和段页式存储管理。

#### 分页存储管理

- 基本思想：将一个进程的逻辑地址空间分成若干大小相等的片，称为**页面或页（page）**；相应地，把内存空间分为与页面相同大小的若干存储块，**称为（物理）块（block）或页框（frame）**。
  在为进程分配内存时，以块为单位将进程中若干页分别装入到多个可以不邻接的物理块中。<u>对应的信息储存在每一个进程的**页表（page table）**中。</u>

- 纯分页存储管理方式（基本的分页存储管理方式）：把每个作业全部装入内存后方能运行。不具有支持实现虚拟存储器的功能。

  ##### 一些需要考虑的问题

- 页面大小：一般为8KB~512KB

- 空间的组织：地址空间为程序限定空间；物理空间为内存限定空间；地址空间分页，内存空间分块；分页的逻辑地址空间结构如下![image-20230404151330544](C:\Users\23237\AppData\Roaming\Typora\typora-user-images\image-20230404151330544.png)

- 页表：每一个进程对应的页面映像表。含有若干标识位（包括存取控制字段等)。页表大多存储在内存中。

  > 在系统中只设置一个页表寄存器PTR（该寄存器属于临界资源），在其中存放当前进程页表在内存的始址和页表的长度。其他的页表都被直接存储在内存中，当前进程结束或被挂起时，下一个进程的运行需要内存读取页表信息。内存读取比cpu来说会慢很多。

  > 页表实际存储在内存时只需要存储块号。因为块的大小是确定的。所以可以按顺序对应页号

- 地址变换：逻辑地址转换为物理地址。

![image-20230404151954462](C:\Users\23237\AppData\Roaming\Typora\typora-user-images\image-20230404151954462.png)

>  提高地址变化速度的方法主要是通过减少进程调度时页表读取的时间-cache。![image-20230404153444498](C:\Users\23237\AppData\Roaming\Typora\typora-user-images\image-20230404153444498.png)

##### 多级页表

当逻辑地址空间很大的时候，页表就会变得非常大。而每一个进程都有一个页表，并且由于页表不存储页号，因此要求其内存空间还要连续。所以使用单级页表是不现实的。

两个方法：离散分配方式解决连续要求问题；导入页表到内存时仅调入部分页表。

这就是多级页表的思路。

#### 分段存储管理

